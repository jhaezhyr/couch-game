<div class="lobby-container">
  <!-- Toast container -->
  @if (toasts().length) {
    <div class="toast-container">
      @for (t of toasts(); track t.id) {
        <div class="toast" [class]="'toast ' + t.type" [attr.data-toast-id]="t.id">
          {{ t.message }}
        </div>
      }
    </div>
  }

  <div class="lobby-header">
    <h1>Couch Game Lobby</h1>
    @if (gameState.error()) {
      <div class="error-message">{{ gameState.error() }}</div>
    }
  </div>

  @if (!gameState.connected()) {
    <div class="connection-panel card">
      <h2>Connecting to Server...</h2>
      <div class="connection-form">
        <div class="loading-spinner"></div>
      </div>
    </div>
  } @else if (!gameState.room()) {
    <app-room-selection
      [loadingSessions]="loadingSessions"
      [activeSessions]="activeSessions"
      (joinRoom)="joinRoom($event)"
      (rejoinSession)="rejoinSession($event)">
    </app-room-selection>
  } @else {
    <div class="game-room">
      @if (gameState.gamePhase() === 'setup') {
        <div class="room-info card">
          <h2>Room: {{ gameState.room()?.id }}</h2>
          <p class="game-phase">Phase: {{ gameState.gamePhase() }}</p>
          @if (gameState.player()) {
            <p class="player-info">Playing as: {{ gameState.player()?.name }}</p>
            @if (gameState.myTeam()) {
              <p class="team-info">Team: {{ gameState.myTeam() }}</p>
            }
          }
        </div>

        <app-player-setup
          [currentPlayerName]="gameState.player()?.name || ''"
          [currentPlayerEmoji]="gameState.player()?.emoji || ''"
          [emojiBank]="emojiBank"
          (nameUpdated)="updatePlayerName($event)"
          (emojiSelected)="setEmoji($event)"
          (focusRequested)="focusNameInput()">
        </app-player-setup>
      }

      @if (gameState.gamePhase() === 'playing') {
        <app-game-controls
          [isCurrentPlayer]="gameState.isCurrentPlayer()"
          [mySecretName]="getMySecretName()"
          [currentPlayerName]="getCurrentPlayerName()"
          [allPlayerNames]="getAllPlayerNames()"
          (nameCall)="callName($event)">
        </app-game-controls>
      }

      <!-- Game layout with responsive design -->
      <div class="game-layout">
        <!-- Playing field -->
        <app-game-board
          [seats]="gameState.room()?.seats || []"
          [gamePhase]="gameState.gamePhase()"
          [currentPlayerId]="getCurrentPlayerId()"
          [myPlayerId]="gameState.player()?.id || null"
          [teams]="gameState.room()?.teams || { A: [], B: [] }"
          (seatClicked)="takeSeat($event)">
        </app-game-board>

        <!-- Recent calls sidebar -->
        <div class="game-info-panel">
          <app-call-history
            [recentCalls]="gameState.recentCalls()"
            [maxDisplayedCalls]="3">
          </app-call-history>
        </div>
      </div>

      @if (gameState.gamePhase() === 'setup') {
        <app-team-assignment
          [teams]="gameState.room()?.teams || { A: [], B: [] }"
          [canStartGame]="canStartGame()"
          [gameStartBlockerMessage]="getGameStartBlockerMessage()"
          [playerLookupFn]="getPlayerLookup()"
          (startGame)="startGame()">
        </app-team-assignment>
      }

      <div class="room-actions">
        <button class="btn error" (click)="leaveRoom()">Leave Room</button>
      </div>
    </div>
  }
</div>