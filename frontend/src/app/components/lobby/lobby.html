<div class="lobby-container">
  <!-- Toast container -->
  @if (toasts().length) {
    <div class="toast-container">
      @for (t of toasts(); track t.id) {
        <div class="toast" [class]="'toast ' + t.type" [attr.data-toast-id]="t.id">
          {{ t.message }}
        </div>
      }
    </div>
  }

  <div class="lobby-header">
    <h1>Couch Game Lobby</h1>
    @if (gameState.error()) {
      <div class="error-message">{{ gameState.error() }}</div>
    }
  </div>

  @if (!gameState.connected()) {
    <div class="connection-panel card">
      <h2>Connecting to Server...</h2>
      <div class="connection-form">
        <div class="loading-spinner"></div>
      </div>
    </div>
  } @else if (!gameState.room()) {
    <div class="room-panel card">
      <h2>Join or Create Room</h2>
      <div class="room-form">
        <input
          class="input"
          [value]="roomId()"
          (input)="roomId.set($any($event.target).value)"
          placeholder="Enter room ID (or leave empty for new room)"
          (keyup.enter)="joinRoom()"
        />
        <button class="btn success" (click)="joinRoom()">
          @if (roomId().trim()) {
            Join Room
          } @else {
            Create New Room
          }
        </button>
      </div>
    </div>
  } @else {
    <div class="game-room">
      

      @if (gameState.gamePhase() === 'setup') {
        <div class="room-info card">
          <h2>Room: {{ gameState.room()?.id }}</h2>
          <p class="game-phase">Phase: {{ gameState.gamePhase() }}</p>
          @if (gameState.player()) {
            <p class="player-info">Playing as: {{ gameState.player()?.name }}</p>
            @if (gameState.myTeam()) {
              <p class="team-info">Team: {{ gameState.myTeam() }}</p>
            }
          }
        </div>

        <div class="player-setup card">
          <h3>Set Your Identity</h3>
          
          <div class="setup-sections">
            <!-- Name section -->
            <div class="name-section">
              <h4>Your Name</h4>
              <div class="identity-form">
                <input
                  class="input"
                  [value]="playerName()"
                  (input)="playerName.set($any($event.target).value)"
                  placeholder="Enter your name for this game"
                  (keyup.enter)="updatePlayerName()"
                />
                <button 
                  class="btn primary" 
                  (click)="updatePlayerName()" 
                  [disabled]="!playerName().trim() || playerName().trim() === gameState.player()?.name">
                  Update Name
                </button>
              </div>
            </div>

            <!-- Avatar section -->
            <div class="avatar-section">
              <h4>Your Avatar</h4>
              <div class="emoji-grid">
                @for (emoji of emojiBank; track emoji) {
                  <button
                    type="button"
                    class="emoji-btn"
                    [class.selected]="gameState.player()?.emoji === emoji"
                    (click)="setEmoji(emoji, $event)">
                    {{ emoji }}
                  </button>
                }
              </div>
              @if (gameState.player()?.emoji) {
                <p class="current-emoji">Selected: {{ gameState.player()?.emoji }}</p>
              } @else {
                <p class="current-emoji">Select an emoji above</p>
              }
            </div>
          </div>
        </div>
      }

      @if (gameState.gamePhase() === 'playing') {
        <div class="game-controls card">
          @if (gameState.isCurrentPlayer()) {
            <div class="current-turn">
              <h3>It's your turn!</h3>
              <p>Your secret name: <strong>{{ getMySecretName() }}</strong></p>
              <p>Call a name to make that person move to the empty seat:</p>
              <div class="name-selection">
                @for (name of getAllPlayerNames(); track name) {
                  <button
                    class="btn primary name-btn"
                    (click)="callName(name)"
                    [disabled]="name === getMySecretName()">
                    {{ name }}
                  </button>
                }
              </div>
            </div>
          } @else {
            <p class="waiting-turn">Waiting for {{ getCurrentPlayerName() }}'s move...</p>
            <p class="secret-name">Your secret name: <strong>{{ getMySecretName() }}</strong></p>
          }
        </div>
      }

      <!-- Game layout with responsive design -->
      <div class="game-layout">
        <!-- Playing field -->
        <div class="couch-area">
          <div class="flow-indicator">Players move clockwise around the circle</div>
          <div class="couch">
            <div class="seats-grid">
              @for (seat of gameState.room()?.seats; track $index) {
                @if (gameState.gamePhase() === 'setup') {
                  <button
                    type="button"
                    class="seat circular-seat"
                    [class.occupied]="seat !== null"
                    [class.current-player]="isCurrentPlayerSeat($index)"
                    [class.team-a]="getPlayerTeam(seat?.id) === 'A'"
                    [class.team-b]="getPlayerTeam(seat?.id) === 'B'"
                    [class.my-seat]="seat?.id === gameState.player()?.id"
                    [class.couch-seat]="isCouchSeat($index)"
                    [style.left]="getCircularPosition($index, gameState.room()?.seats?.length || 0).x"
                    [style.top]="getCircularPosition($index, gameState.room()?.seats?.length || 0).y"
                    (click)="takeSeat($index)"
                    [attr.aria-label]="seat ? 'Seat for ' + seat.name : 'Empty seat'"
                  >
                    @if (seat) {
                      <div class="seat-content">
                        @if (seat.emoji) {
                          <span class="seat-emoji">{{ seat.emoji }}</span>
                        }
                        <span class="seat-name">{{ seat.name }}</span>
                      </div>
                    } @else {
                      <span class="seat-placeholder">+</span>
                    }
                  </button>
                } @else {
                  <div
                    class="seat circular-seat"
                    [class.occupied]="seat !== null"
                    [class.current-player]="isCurrentPlayerSeat($index)"
                    [class.team-a]="getPlayerTeam(seat?.id) === 'A'"
                    [class.team-b]="getPlayerTeam(seat?.id) === 'B'"
                    [class.my-seat]="seat?.id === gameState.player()?.id"
                    [class.couch-seat]="isCouchSeat($index)"
                    [style.left]="getCircularPosition($index, gameState.room()?.seats?.length || 0).x"
                    [style.top]="getCircularPosition($index, gameState.room()?.seats?.length || 0).y"
                  >
                    @if (seat) {
                      <div class="seat-content">
                        @if (seat.emoji) {
                          <span class="seat-emoji">{{ seat.emoji }}</span>
                        }
                        <span class="seat-name">{{ seat.name }}</span>
                      </div>
                    } @else {
                      <span class="seat-placeholder">+</span>
                    }
                  </div>
                }
              }
            </div>
          </div>
        </div>

        <!-- Recent calls sidebar -->
        <div class="game-info-panel">
          
          @if (gameState.recentCalls().length) {
            <div class="call-history card">
              <h3>Recent calls</h3>
              <ul class="call-list">
                @for (c of getDisplayedRecentCalls(); track c.at) {
                  <li>
                    <span class="caller">{{ c.callerName }}</span>
                    <span class="verb"> called </span>
                    <span class="called">"{{ c.calledName }}"</span>
                    @if (c.movedPlayerName) {
                      <div class="move-result">â†’ {{ c.movedPlayerName }} moved to the empty seat</div>
                    }
                  </li>
                }
              </ul>
              @if (getHiddenCallsCount() > 0) {
                <div class="more-calls-indicator">
                  ... and {{ getHiddenCallsCount() }} more calls before
                </div>
              }
            </div>
          }
        </div>
      </div>

      @if (gameState.gamePhase() === 'setup') {
        <div class="team-assignment card">
          <h3>Team Assignment</h3>
          <div class="teams-display">
            <div class="team team-a">
              <h4>Team A</h4>
              <div class="team-members">
                @for (playerId of (gameState.room()?.teams?.A || []); track playerId) {
                  <span class="team-member">
                    @if (getPlayerEmoji(playerId)) {
                      <span class="team-member-emoji">{{ getPlayerEmoji(playerId) }}</span>
                    }
                    <span class="team-member-name">{{ getPlayerName(playerId) }}</span>
                  </span>
                }
              </div>
            </div>
            <div class="team team-b">
              <h4>Team B</h4>
              <div class="team-members">
                @for (playerId of (gameState.room()?.teams?.B || []); track playerId) {
                  <span class="team-member">
                    @if (getPlayerEmoji(playerId)) {
                      <span class="team-member-emoji">{{ getPlayerEmoji(playerId) }}</span>
                    }
                    <span class="team-member-name">{{ getPlayerName(playerId) }}</span>
                  </span>
                }
              </div>
            </div>
          </div>

          @if (canStartGame()) {
            <button class="btn success pulse-success" (click)="startGame()">
              Start Game!
            </button>
          } @else {
            <div class="setup-instructions">
              <p class="blocker-message">{{ getGameStartBlockerMessage() }}</p>
            </div>
          }
        </div>
      }

      <div class="room-actions">
        <button class="btn error" (click)="leaveRoom()">Leave Room</button>
      </div>
    </div>
  }
</div>
